<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Traffic Monitor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 30px; background: #f8f9fa; }
    #chart-container { width: 80%; margin: auto; }
    #log-box { width: 80%; margin: auto; height: 200px; overflow-y: auto;
      background:#111; color:#0f0; padding:10px; font-family:monospace; text-align:left; }
  </style>
</head>
<body>
  <h2>Live Traffic Monitor For AmberIT</h2>
  <div id="chart-container"><canvas id="trafficChart"></canvas></div>
  <h3>Logs</h3>
  <div id="log-box"></div>

  <script>
    const ctx = document.getElementById("trafficChart").getContext("2d");
    const chartData = { labels: [], datasets: [
      { label: "Download (Mbps)", borderColor: "cyan", data: [], fill: false },
      { label: "Upload (Mbps)", borderColor: "magenta", data: [], fill: false }
    ]};
    const trafficChart = new Chart(ctx, { type: "line", data: chartData });

    function formatMbps(bytes) { return (bytes / (1024 * 1024)).toFixed(2); }
    const logBox = document.getElementById("log-box");
    function addLog(message) {
      const div = document.createElement("div");
      div.textContent = message;
      logBox.appendChild(div);
      logBox.scrollTop = logBox.scrollHeight;
    }

    const socket = new WebSocket("ws://localhost:4000");

    socket.onopen = () => {
      const cid = prompt("Enter CID:");
      if (cid) {
        socket.send(JSON.stringify({ type: "start", cid }));
        addLog("[INFO] Sent CID " + cid + " to backend");
      }
    };

    socket.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      if (msg.type === "traffic") {
        const timestamp = new Date(msg.Timestamp).toLocaleTimeString();
        if (chartData.labels.length > 19) {
          chartData.labels.shift(); chartData.datasets[0].data.shift(); chartData.datasets[1].data.shift();
        }
        chartData.labels.push(timestamp);
        chartData.datasets[0].data.push(formatMbps(msg.Tx));
        chartData.datasets[1].data.push(formatMbps(msg.Rx));
        trafficChart.update();
      } else if (msg.type === "log") {
        addLog(msg.message);
      }
    };
  </script>
</body>
</html>
